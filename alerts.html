<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RPM Prototype – Alerts</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>

<header class="app-header">
    <div class="header-left">
        <img src="./logo.png" class="logo" alt="App logo">
        <strong>RPM Prototype</strong>
    </div>

    <nav class="header-nav">
        <a href="dashboard.html">Home</a>
        <a href="trends.html">Trends</a>
        <a class="active" href="alerts.html">Alerts</a>
        <a href="profile.html">Profile</a>
        <button id="logoutBtn" class="btn-ghost">Log out</button>
    </nav>
</header>

<main class="container">
    <section class="card">
        <div class="row between">
            <h2>Alerts</h2>
            <a href="dashboard.html" class="btn-light">Home</a>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>Patient</th>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Value</th>
                </tr>
            </thead>

            <tbody id="alertsTable">
                <tr><td colspan="4">Loading...</td></tr>
            </tbody>
        </table>
    </section>
</main>

<script type="module">
import { currentUser } from "./auth.js";
import { getReadingsById } from "./api.js";

const table = document.getElementById("alertsTable");

// Identify user
const user = currentUser();
const params = new URLSearchParams(location.search);
let pid = user.role === "patient" ? user.id : params.get("pid");

// PROVIDER opened Alerts.html directly
if (user.role === "provider" && !pid) {
    table.innerHTML = `
        <tr>
            <td colspan="4" style="padding:20px; text-align:center;">
            Select a patient first from Dashboard → View.
            </td>
        </tr>`;
    return;
}

// Fetch readings
let readings = await getReadingsById(pid);

// No readings for this patient
if (!readings || readings.length === 0) {
    table.innerHTML = `
        <tr>
            <td colspan="4" style="padding:20px; text-align:center;">
            No alerts — no vitals recorded.
            </td>
        </tr>`;
    return;
}

// Determine alerts
function getAlerts(r) {
    const rows = [];

    if (r.bp_systolic > 140) rows.push(["Systolic BP", r.bp_systolic]);
    if (r.bp_diastolic > 90) rows.push(["Diastolic BP", r.bp_diastolic]);
    if (r.hr > 100) rows.push(["Heart Rate", r.hr]);
    if (r.glucose > 180) rows.push(["Glucose", r.glucose]);

    return rows;
}

let html = "";

// Loop through all readings
readings.forEach(r => {
    const alerts = getAlerts(r);

    alerts.forEach(a => {
        html += `
        <tr>
            <td>${pid}</td>
            <td>${r.date}</td>
            <td>${a[0]}</td>
            <td>${a[1]}</td>
        </tr>
        `;
    });
});

// No alerts at all
if (html === "") {
    table.innerHTML = `
        <tr>
            <td colspan="4" style="padding:20px; text-align:center;">
            No alerts — all vitals normal.
            </td>
        </tr>`;
} else {
    table.innerHTML = html;
}

</script>
</body>
</html>
