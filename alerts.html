<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>RPM Prototype – Alerts</title>
    <link rel="stylesheet" href="./styles.css" />
    <script type="module" src="./alerts.js"></script>
</head>

<body>

<header class="app-header">
    <div class="header-left">
        <img src="./logo.png" class="logo" alt="App logo" />
        <strong>RPM Prototype</strong>
    </div>

    <nav class="header-nav">
        <a href="dashboard.html">Home</a>
        <a href="trends.html">Trends</a>
        <a class="active" href="alerts.html">Alerts</a>
        <a href="profile.html">Profile</a>
        <button id="logoutBtn" class="btn-ghost">Log out</button>
    </nav>
</header>


<main class="container">
    <section class="card">
        <div class="row between">
            <h2>Alerts</h2>
            <a href="dashboard.html" class="btn-light">Home</a>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>Patient</th>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody id="alertsTable">
                <tr><td colspan="4">Loading...</td></tr>
            </tbody>
        </table>
    </section>
</main>


<script type="module">
import { currentUser } from "./auth.js";
import { getReadingsById } from "./api.js";

const user = currentUser();

// PATIENT → own ID
// PROVIDER → require patient selected OR show message
const params = new URLSearchParams(location.search);
const pidURL = params.get("pid");

let pid = user.role === "patient" ? user.id : pidURL;

const tableBody = document.getElementById("alertsTable");

// If provider opened Alerts directly → show message
if (user.role === "provider" && !pid) {
    tableBody.innerHTML = `
        <tr>
            <td colspan="4" style="padding:20px; text-align:center;">
                Please select a patient from Dashboard → View to see alerts.
            </td>
        </tr>`;
    throw new Error("Provider missing PID");
}

let readings = await getReadingsById(pid);

// If no readings exist for this patient
if (!readings || readings.length === 0) {
    tableBody.innerHTML = `
        <tr>
            <td colspan="4" style="padding:20px; text-align:center;">
                No alerts — no vitals recorded for this patient.
            </td>
        </tr>`;
    return;
}

// Function to determine alert conditions
function isAlert(r) {
    return (
        r.sbp > 140 ||
        r.dbp > 90 ||
        r.hr > 100 ||
        r.glucose > 180
    );
}

let alerts = readings.filter(isAlert);

// If readings exist but no alerts triggered
if (alerts.length === 0) {
    tableBody.innerHTML = `
        <tr>
            <td colspan="4" style="padding:20px; text-align:center;">
                No alerts — all vitals are normal.
            </td>
        </tr>`;
    return;
}

// Helper to print one alert row
function row(r, type, value) {
    return `
        <tr>
            <td>${pid}</td>
            <td>${r.date}</td>
            <td>${type}</td>
            <td>${value}</td>
        </tr>`;
}

let html = "";

// Loop through readings & generate individual alerts
alerts.forEach(r => {
    if (r.sbp > 140) html += row(r, "Systolic BP", r.sbp);
    if (r.dbp > 90) html += row(r, "Diastolic BP", r.dbp);
    if (r.hr > 100) html += row(r, "Heart Rate", r.hr);
    if (r.glucose > 180) html += row(r, "Glucose", r.glucose);
});

tableBody.innerHTML = html;

</script>

</body>
</html>

