<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RPM Prototype â€“ Alerts</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<header class="app-header">
  <div class="header-left">
    <img src="./logo.png" class="logo" alt="App logo" />
    <strong>RPM Prototype</strong>
  </div>
  <nav class="header-nav">
    <a href="dashboard.html">Home</a>
    <a href="trends.html">Trends</a>
    <a class="active" href="alerts.html">Alerts</a>
    <a href="profile.html">Profile</a>
    <button id="logoutBtn" class="btn-ghost">Log out</button>
  </nav>
</header>

<main class="container">
  <section class="card">
    <div class="row between">
      <h2>Alerts</h2>
      <a class="btn-ghost" href="dashboard.html">Home</a>
    </div>
    <div id="alertsRoot" class="mt-12"></div>
  </section>
</main>

<script type="module">
  import "./router.js";
  import { currentUser } from "./auth.js";
  import { getReadings, getAssignedPatients } from "./api.js";

  const TH = { sys: 140, dia: 90, hr: 110, glu: 180 };

  async function init() {
    const user = currentUser();
    if (!user) return;

    const root = document.getElementById("alertsRoot");

    function buildAlerts(patientId, rows) {
      const out = [];
      for (const r of rows) {
        if (r.bp_systolic >= TH.sys)
          out.push({ patient: patientId, date: r.date, type: "Systolic BP", value: r.bp_systolic });
        if (r.bp_diastolic >= TH.dia)
          out.push({ patient: patientId, date: r.date, type: "Diastolic BP", value: r.bp_diastolic });
        if (r.hr >= TH.hr)
          out.push({ patient: patientId, date: r.date, type: "Heart Rate", value: r.hr });
        if (r.glucose >= TH.glu)
          out.push({ patient: patientId, date: r.date, type: "Glucose", value: r.glucose });
      }
      return out;
    }

    let alerts = [];

    if (user.role === "patient") {
      const rows = await getReadings(user.id);
      alerts = buildAlerts(user.id, rows);
    } else {
      const ids = await getAssignedPatients(user.id);
      for (const pid of ids) {
        const rows = await getReadings(pid);
        alerts.push(...buildAlerts(pid, rows));
      }
    }

    if (!alerts.length) {
      root.innerHTML = `<p class="muted">No active alerts ðŸŽ‰</p>`;
      return;
    }

    alerts.sort((a, b) =>
      (b.date + b.patient).localeCompare(a.date + a.patient)
    );

    root.innerHTML = `
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Patient</th>
              <th>Date</th>
              <th>Type</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            ${alerts
              .map(
                a => `<tr>
                  <td>${a.patient}</td>
                  <td>${a.date}</td>
                  <td>${a.type}</td>
                  <td>${a.value}</td>
                </tr>`
              )
              .join("")}
          </tbody>
        </table>
      </div>
    `;
  }

  init();
</script>
</body>
</html>
